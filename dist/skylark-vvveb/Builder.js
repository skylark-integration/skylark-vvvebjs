/**
 * skylark-vvveb - A version of Vvveb.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-vvveb/
 * @license MIT
 */
define(["skylark-utils-dom/query","./Vvveb"],function(e,t){var n=e;return t.Builder={component:{},dragMoveMutation:!1,isPreview:!1,runJsOnSetHtml:!1,designerMode:!1,init:function(t,n){this.loadControlGroups(),this.loadBlockGroups(),this.selectedEl=null,this.highlightEl=null,this.initCallback=n,this.documentFrame=e("#iframe-wrapper > iframe"),this.canvas=e("#canvas"),this._loadIframe(t),this._initDragdrop(),this._initBox(),this.dragElement=null},loadControlGroups:function(){var n=e(".components-list");n.empty();var o={},a={};n.each(function(){var n=e(this),l=this.dataset.type;for(group in t.ComponentsGroup){n.append('<li class="header clearfix" data-section="'+group+'"  data-search=""><label class="header" for="'+l+"_comphead_"+group+'">'+group+'  <div class="header-arrow"></div>\t\t\t\t\t\t\t\t\t\t   </label><input class="header_check" type="checkbox" checked="true" id="'+l+"_comphead_"+group+'">  <ol></ol></li>');var r=n.find('li[data-section="'+group+'"]  ol');for(i in components=t.ComponentsGroup[group],components)componentType=components[i],(a=t.Components.get(componentType))&&(o=e('<li data-section="'+group+'" data-drag-type=component data-type="'+componentType+'" data-search="'+a.name.toLowerCase()+'"><a href="#">'+a.name+"</a></li>"),a.image&&o.css({backgroundImage:"url("+a.image+")",backgroundRepeat:"no-repeat"}),r.append(o))}})},loadBlockGroups:function(){var n=e(".blocks-list");n.empty();var o={};n.each(function(){var n=e(this),a=this.dataset.type;for(group in t.BlocksGroup){n.append('<li class="header" data-section="'+group+'"  data-search=""><label class="header" for="'+a+"_blockhead_"+group+'">'+group+'  <div class="header-arrow"></div>\t\t\t\t\t\t\t\t\t\t   </label><input class="header_check" type="checkbox" checked="true" id="'+a+"_blockhead_"+group+'">  <ol></ol></li>');var l=n.find('li[data-section="'+group+'"]  ol');for(i in blocks=t.BlocksGroup[group],blocks)blockType=blocks[i],block=t.Blocks.get(blockType),block&&(o=e('<li data-section="'+group+'" data-drag-type=block data-type="'+blockType+'" data-search="'+block.name.toLowerCase()+'"><a href="#">'+block.name+"</a></li>"),block.image&&o.css({backgroundImage:"url("+(-1==block.image.indexOf("//")?"libs/builder/":"")+block.image+")",backgroundRepeat:"no-repeat"}),l.append(o))}})},loadUrl:function(e,o){n("#select-box").hide(),self.initCallback=o,t.Builder.iframe.src!=e&&(t.Builder.iframe.src=e)},_loadIframe:function(o){var i=this;return i.iframe=this.documentFrame.get(0),i.iframe.src=o,this.documentFrame.on("load",function(){return window.FrameWindow=i.iframe.contentWindow,window.FrameDocument=i.iframe.contentWindow.document,e(window.FrameWindow).on("beforeunload",function(e){if(t.Undo.undoIndex<=0){return e.returnValue="You have unsaved changes","You have unsaved changes"}}),n(window.FrameWindow).on("scroll resize",function(e){if(i.selectedEl){var t=i.selectedEl.offset();n("#select-box").css({top:t.top-i.frameDoc.scrollTop(),left:t.left-i.frameDoc.scrollLeft(),width:i.selectedEl.outerWidth(),height:i.selectedEl.outerHeight()})}if(i.highlightEl){t=i.highlightEl.offset();n("#highlight-box").css({top:t.top-i.frameDoc.scrollTop(),left:t.left-i.frameDoc.scrollLeft(),width:i.highlightEl.outerWidth(),height:i.highlightEl.outerHeight()})}}),t.WysiwygEditor.init(window.FrameDocument),i.initCallback&&i.initCallback(),i._frameLoaded()})},_frameLoaded:function(){var n=t.Builder;n.frameDoc=e(window.FrameDocument),n.frameHtml=e(window.FrameDocument).find("html"),n.frameBody=e(window.FrameDocument).find("body"),n.frameHead=e(window.FrameDocument).find("head"),n.frameHead.append('<link data-vvveb-helpers href="'+t.baseUrl+'../../css/vvvebjs-editor-helpers.css" rel="stylesheet">'),n._initHighlight()},_getElementType:function(e){if(componentName="",e.attributes)for(var t=0;t<e.attributes.length;t++)e.attributes[t].nodeName.indexOf("data-component")>-1&&(componentName=e.attributes[t].nodeName.replace("data-component-",""));return""!=componentName?componentName:e.tagName},loadNodeComponent:function(e){var n;data=t.Components.matchNode(e),n=data?data.type:t.defaultComponent,t.Components.render(n)},selectNode:function(e){if(e){this.texteditEl&&this.selectedEl.get(0)!=e&&(t.WysiwygEditor.destroy(this.texteditEl),n("#select-box").removeClass("text-edit").find("#select-actions").show(),this.texteditEl=null);var o=n(e);if(o){this.selectedEl=o;try{var i=o.offset();n("#select-box").css({top:i.top-this.frameDoc.scrollTop(),left:i.left-this.frameDoc.scrollLeft(),width:o.outerWidth(),height:o.outerHeight(),display:"block"})}catch(e){return console.log(e),!1}}n("#highlight-name").html(this._getElementType(e))}else n("#select-box").hide()},_initHighlight:function(){var o=t.Builder;o.frameHtml.on("mousemove touchmove",function(e){if(e.target&&t.isElement(e.target)&&e.originalEvent){o.highlightEl=target=n(e.target);var i=target.offset(),a=target.outerHeight(),l=Math.max(a/2,50),r=target.outerWidth(),d=Math.max(r/2,50),c=e.clientX||e.originalEvent.clientX,s=e.clientY||e.originalEvent.clientY;if(o.isDragging){var g=o.highlightEl;try{if(e.originalEvent&&(i.top<s-l||i.left<c-d?t.isIE11?o.highlightEl.append(o.dragElement):o.dragElement.appendTo(g):t.isIE11?o.highlightEl.prepend(o.dragElement):o.dragElement.prependTo(g),o.designerMode)){var m=o.dragElement.offsetParent().offset();o.dragElement.css({position:"absolute",left:c-(m.left-o.frameDoc.scrollLeft()),top:s-(m.top-o.frameDoc.scrollTop())})}}catch(e){return console.log(e),!1}!o.designerMode&&o.iconDrag&&o.iconDrag.css({left:c+275,top:s-30})}n("#highlight-box").css({top:i.top-o.frameDoc.scrollTop(),left:i.left-o.frameDoc.scrollLeft(),width:r,height:a,display:e.target.hasAttribute("contenteditable")?"none":"block",border:o.isDragging?"1px dashed aqua":""}),n("#highlight-name").html(o._getElementType(e.target)),o.isDragging?n("#highlight-name").hide():n("#highlight-name").show()}}),o.frameHtml.on("mouseup touchend",function(n){o.isDragging&&(o.isDragging=!1,o.iconDrag&&o.iconDrag.remove(),e("#component-clone").remove(),o.component.dragHtml&&(newElement=e(o.component.html),o.dragElement.replaceWith(newElement),o.dragElement=newElement),o.component.afterDrop&&(o.dragElement=o.component.afterDrop(o.dragElement)),o.dragElement.css("border",""),node=o.dragElement.get(0),o.selectNode(node),o.loadNodeComponent(node),!1===o.dragMoveMutation?t.Undo.addMutation({type:"childList",target:node.parentNode,addedNodes:[node],nextSibling:node.nextSibling}):(o.dragMoveMutation.newParent=node.parentNode,o.dragMoveMutation.newNextSibling=node.nextSibling,t.Undo.addMutation(o.dragMoveMutation),o.dragMoveMutation=!1))}),o.frameHtml.on("dblclick",function(e){0==t.Builder.isPreview&&(o.texteditEl=target=n(e.target),t.WysiwygEditor.edit(o.texteditEl),o.texteditEl.attr({contenteditable:!0,spellcheckker:!1}),o.texteditEl.on("blur keyup paste input",function(e){n("#select-box").css({width:o.texteditEl.outerWidth(),height:o.texteditEl.outerHeight()})}),n("#select-box").addClass("text-edit").find("#select-actions").hide(),n("#highlight-box").hide())}),o.frameHtml.on("click",function(n){if(0==t.Builder.isPreview)return n.target&&(e(".component-properties-tab").is(":visible")&&e(".component-properties-tab a").show().tab("show"),o.selectNode(n.target),o.loadNodeComponent(n.target)),n.preventDefault(),!1})},_initBox:function(){var o=this;e("#drag-btn").on("mousedown",function(e){return n("#select-box").hide(),o.dragElement=o.selectedEl.css("position",""),o.isDragging=!0,node=o.dragElement.get(0),o.dragMoveMutation={type:"move",target:node,oldParent:node.parentNode,oldNextSibling:node.nextSibling},e.preventDefault(),!1}),e("#down-btn").on("click",function(e){return n("#select-box").hide(),node=o.selectedEl.get(0),oldParent=node.parentNode,oldNextSibling=node.nextSibling,next=o.selectedEl.next(),next.length>0?next.after(o.selectedEl):o.selectedEl.parent().after(o.selectedEl),newParent=node.parentNode,newNextSibling=node.nextSibling,t.Undo.addMutation({type:"move",target:node,oldParent:oldParent,newParent:newParent,oldNextSibling:oldNextSibling,newNextSibling:newNextSibling}),e.preventDefault(),!1}),e("#up-btn").on("click",function(e){return n("#select-box").hide(),node=o.selectedEl.get(0),oldParent=node.parentNode,oldNextSibling=node.nextSibling,next=o.selectedEl.prev(),next.length>0?next.before(o.selectedEl):o.selectedEl.parent().before(o.selectedEl),newParent=node.parentNode,newNextSibling=node.nextSibling,t.Undo.addMutation({type:"move",target:node,oldParent:oldParent,newParent:newParent,oldNextSibling:oldNextSibling,newNextSibling:newNextSibling}),e.preventDefault(),!1}),e("#clone-btn").on("click",function(e){return clone=o.selectedEl.clone(),o.selectedEl.after(clone),o.selectedEl=clone.click(),node=clone.get(0),t.Undo.addMutation({type:"childList",target:node.parentNode,addedNodes:[node],nextSibling:node.nextSibling}),e.preventDefault(),!1}),e("#parent-btn").on("click",function(e){return node=o.selectedEl.parent().get(0),o.selectNode(node),o.loadNodeComponent(node),e.preventDefault(),!1}),e("#delete-btn").on("click",function(e){return n("#select-box").hide(),node=o.selectedEl.get(0),t.Undo.addMutation({type:"childList",target:node.parentNode,removedNodes:[node],nextSibling:node.nextSibling}),o.selectedEl.remove(),e.preventDefault(),!1});var i=n("#add-section-box"),a={};function l(n,o=!0){var i=e(n);o?a.after(i):a.append(i),i=i.get(0),t.Undo.addMutation({type:"childList",target:i.parentNode,addedNodes:[i],nextSibling:i.nextSibling})}e("#add-section-btn").on("click",function(t){a=o.highlightEl;var l=n(this).offset();return i.css({top:l.top-o.frameDoc.scrollTop()-e(this).outerHeight(),left:l.left-i.outerWidth()/2-275-o.frameDoc.scrollLeft(),display:"block"}),t.preventDefault(),!1}),e("#close-section-btn").on("click",function(e){i.hide()}),e(".components-list li ol li",i).on("click",function(e){l(t.Components.get(this.dataset.type).html,"after"==n("[name='add-section-insert-mode']:checked").val()),i.hide()}),e(".blocks-list li ol li",i).on("click",function(e){l(t.Blocks.get(this.dataset.type).html,"after"==n("[name='add-section-insert-mode']:checked").val()),i.hide()})},_initDragdrop:function(){var o=this;o.isDragging=!1,e(".drag-elements-sidepane ul > li > ol > li").on("mousedown touchstart",function(i){return $this=n(this),e("#component-clone").remove(),"component"==$this.data("drag-type")?o.component=t.Components.get($this.data("type")):o.component=t.Blocks.get($this.data("type")),o.component.dragHtml?html=o.component.dragHtml:html=o.component.html,o.dragElement=e(html),o.dragElement.css("border","1px dashed #4285f4"),o.component.dragStart&&(o.dragElement=o.component.dragStart(o.dragElement)),o.isDragging=!0,"html"==t.dragIcon?o.iconDrag=e(html).attr("id","dragElement-clone").css("position","absolute"):0==o.designerMode&&(o.iconDrag=e('<img src=""/>').attr({id:"dragElement-clone",src:$this.css("background-image").replace(/^url\(['"](.+)['"]\)/,"$1")}).css({"z-index":100,position:"absolute",width:"64px",height:"64px",top:i.originalEvent.y,left:i.originalEvent.x})),e("body").append(o.iconDrag),i.preventDefault(),!1}),e("body").on("mouseup touchend",function(t){o.iconDrag&&1==o.isDragging&&(o.isDragging=!1,e("#component-clone").remove(),o.iconDrag.remove(),o.dragElement&&o.dragElement.remove())}),e("body").on("mousemove touchmove",function(e){if(o.iconDrag&&1==o.isDragging){var t=e.clientX||e.originalEvent.clientX,n=e.clientY||e.originalEvent.clientY;o.iconDrag.css({left:t-60,top:n-30}),elementMouseIsOver=document.elementFromPoint(t-60,n-40),elementMouseIsOver&&"IFRAME"==elementMouseIsOver.tagName&&(o.frameBody.trigger("mousemove",e),e.stopPropagation(),o.selectNode(!1))}}),e(".drag-elements-sidepane ul > ol > li > li").on("mouseup touchend",function(t){o.isDragging=!1,e("#component-clone").remove()})},removeHelpers:function(e,t=!1){return e=e.replace(/<.*?data-vvveb-helpers.*?>/gi,""),t||(e=e.replace(/\s*data-vvveb-\w+(=["'].*?["'])?\s*/gi,"")),e},getHtml:function(e=!0){var t=window.FrameDocument,n="";return null!==t.doctype&&(n="<!DOCTYPE "+t.doctype.name+(t.doctype.publicId?' PUBLIC "'+t.doctype.publicId+'"':"")+(!t.doctype.publicId&&t.doctype.systemId?" SYSTEM":"")+(t.doctype.systemId?' "'+t.doctype.systemId+'"':"")+">\n"),n+=t.documentElement.innerHTML+"\n</html>",this.removeHelpers(n,e)},setHtml:function(e){start=e.indexOf("<body"),end=e.indexOf("</body"),start>=0&&end>=0?body=e.slice(e.indexOf(">",start)+1,end):body=e,this.runJsOnSetHtml?self.frameBody.html(body):window.FrameDocument.body.innerHTML=body},saveAjax:function(n,o,i){var a={};a.fileName=n&&""!=n?n:t.FileManager.getCurrentUrl(),a.startTemplateUrl=o,o&&null!=o||(a.html=this.getHtml()),e.ajax({type:"POST",url:"save.php",data:a,cache:!1,success:function(e){i&&i(e)},error:function(e){alert(e.responseText)}})},setDesignerMode:function(e=!1){this.designerMode=e}}});
//# sourceMappingURL=sourcemaps/Builder.js.map
