/**
 * skylark-vvveb - A version of Vvveb.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-vvveb/
 * @license MIT
 */
define(["skylark-jquery","./Vvveb"],function(e,t){var o=e;return t.Builder={component:{},dragMoveMutation:!1,isPreview:!1,runJsOnSetHtml:!1,designerMode:!1,init:function(t,o){this.loadControlGroups(),this.loadBlockGroups(),this.selectedEl=null,this.highlightEl=null,this.initCallback=o,this.documentFrame=e("#iframe-wrapper > iframe"),this.canvas=e("#canvas"),this._loadIframe(t),this._initDragdrop(),this._initBox(),this.dragElement=null},loadControlGroups:function(){var o=e(".components-list");o.empty();var n={},a={},l=0;o.each(function(){var o=e(this),r=this.dataset.type;for(group in l++,t.ComponentsGroup){o.append('<li class="header clearfix" data-section="'+group+'"  data-search=""><label class="header" for="'+r+"_comphead_"+group+l+'">'+group+'  <div class="header-arrow"></div>\t\t\t\t\t\t\t\t\t\t   </label><input class="header_check" type="checkbox" checked="true" id="'+r+"_comphead_"+group+l+'">  <ol></ol></li>');var d=o.find('li[data-section="'+group+'"]  ol');for(i in components=t.ComponentsGroup[group],components)componentType=components[i],(a=t.Components.get(componentType))&&(n=e('<li data-section="'+group+'" data-drag-type=component data-type="'+componentType+'" data-search="'+a.name.toLowerCase()+'"><a href="#">'+a.name+"</a></li>"),a.image&&n.css({backgroundImage:"url(libs/builder/"+a.image+")",backgroundRepeat:"no-repeat"}),d.append(n))}})},loadBlockGroups:function(){var o=e(".blocks-list");o.empty();var n={};o.each(function(){var o=e(this),a=this.dataset.type;for(group in t.BlocksGroup){o.append('<li class="header" data-section="'+group+'"  data-search=""><label class="header" for="'+a+"_blockhead_"+group+'">'+group+'  <div class="header-arrow"></div>\t\t\t\t\t\t\t\t\t\t   </label><input class="header_check" type="checkbox" checked="true" id="'+a+"_blockhead_"+group+'">  <ol></ol></li>');var l=o.find('li[data-section="'+group+'"]  ol');for(i in blocks=t.BlocksGroup[group],blocks)blockType=blocks[i],block=t.Blocks.get(blockType),block&&(n=e('<li data-section="'+group+'" data-drag-type=block data-type="'+blockType+'" data-search="'+block.name.toLowerCase()+'"><a href="#">'+block.name+"</a></li>"),block.image&&n.css({backgroundImage:"url("+(-1==block.image.indexOf("//")?"libs/builder/":"")+block.image+")",backgroundRepeat:"no-repeat"}),l.append(n))}})},loadUrl:function(e,n){o("#select-box").hide(),this.initCallback=n,t.Builder.iframe.src!=e&&(t.Builder.iframe.src=e)},_loadIframe:function(n){var i=this;return i.iframe=this.documentFrame.get(0),i.iframe.src=n,this.documentFrame.on("load",function(){window.FrameWindow=i.iframe.contentWindow,window.FrameDocument=i.iframe.contentWindow.document;var n=o("#add-section-box"),a=o("#highlight-box").hide();return e(window.FrameWindow).on("beforeunload",function(e){if(t.Undo.undoIndex<=0){return e.returnValue="You have unsaved changes","You have unsaved changes"}}),o(window.FrameWindow).on("scroll resize",function(e){if(i.selectedEl){var t=i.selectedEl.offset();o("#select-box").css({top:t.top-i.frameDoc.scrollTop(),left:t.left-i.frameDoc.scrollLeft(),width:i.selectedEl.outerWidth(),height:i.selectedEl.outerHeight()})}if(i.highlightEl){t=i.highlightEl.offset();a.css({top:t.top-i.frameDoc.scrollTop(),left:t.left-i.frameDoc.scrollLeft(),width:i.highlightEl.outerWidth(),height:i.highlightEl.outerHeight()}),n.hide()}}),t.WysiwygEditor.init(window.FrameDocument),i.initCallback&&i.initCallback(),i._frameLoaded()})},_frameLoaded:function(){var o=t.Builder;o.frameDoc=e(window.FrameDocument),o.frameHtml=e(window.FrameDocument).find("html"),o.frameBody=e(window.FrameDocument).find("body"),o.frameHead=e(window.FrameDocument).find("head"),o.frameHead.append('<link data-vvveb-helpers href="'+t.baseUrl+'../../css/vvvebjs-editor-helpers.css" rel="stylesheet">'),o._initHighlight(),e(window).triggerHandler("vvveb.iframe.loaded",o.frameDoc)},_getElementType:function(e){if(componentName="",e.attributes)for(var t=0;t<e.attributes.length;t++)e.attributes[t].nodeName.indexOf("data-component")>-1&&(componentName=e.attributes[t].nodeName.replace("data-component-",""));return""!=componentName?componentName:e.tagName},loadNodeComponent:function(e){var o;data=t.Components.matchNode(e),o=data?data.type:t.defaultComponent,t.Components.render(o)},selectNode:function(e){if(e){this.texteditEl&&this.selectedEl.get(0)!=e&&(t.WysiwygEditor.destroy(this.texteditEl),o("#select-box").removeClass("text-edit").find("#select-actions").show(),this.texteditEl=null);var n=o(e);if(n){this.selectedEl=n;try{var i=n.offset();o("#select-box").css({top:i.top-this.frameDoc.scrollTop(),left:i.left-this.frameDoc.scrollLeft(),width:n.outerWidth(),height:n.outerHeight(),display:"block"})}catch(e){return console.log(e),!1}}o("#highlight-name").html(this._getElementType(e))}else o("#select-box").hide()},_initHighlight:function(){var n=t.Builder;n.frameHtml.on("mousemove touchmove",function(e){if(e.target&&isElement(e.target)&&e.originalEvent){n.highlightEl=target=o(e.target);var t=target.offset(),i=target.outerHeight(),a=Math.max(i/2,50),l=target.outerWidth(),r=Math.max(l/2,50),d=e.clientX||e.originalEvent.clientX,c=e.clientY||e.originalEvent.clientY;if(n.isDragging){var s=n.highlightEl;try{if(e.originalEvent&&(t.top<c-a||t.left<d-r?isIE11?n.highlightEl.append(n.dragElement):n.dragElement.appendTo(s):isIE11?n.highlightEl.prepend(n.dragElement):n.dragElement.prependTo(s),n.designerMode)){var g=n.dragElement.offsetParent().offset();n.dragElement.css({position:"absolute",left:d-(g.left-n.frameDoc.scrollLeft()),top:c-(g.top-n.frameDoc.scrollTop())})}}catch(e){return console.log(e),!1}!n.designerMode&&n.iconDrag&&n.iconDrag.css({left:d+275,top:c-30})}o("#highlight-box").css({top:t.top-n.frameDoc.scrollTop(),left:t.left-n.frameDoc.scrollLeft(),width:l,height:i,display:e.target.hasAttribute("contenteditable")?"none":"block",border:n.isDragging?"1px dashed aqua":""}),i<50?o("#section-actions").addClass("outside"):o("#section-actions").removeClass("outside"),o("#highlight-name").html(n._getElementType(e.target)),n.isDragging?o("#highlight-name").hide():o("#highlight-name").show()}}),n.frameHtml.on("mouseup touchend",function(o){n.isDragging&&(n.isDragging=!1,n.iconDrag&&n.iconDrag.remove(),e("#component-clone").remove(),!1===n.dragMoveMutation&&(n.component.dragHtml&&(newElement=e(n.component.html),n.dragElement.replaceWith(newElement),n.dragElement=newElement),n.component.afterDrop&&(n.dragElement=n.component.afterDrop(n.dragElement))),n.dragElement.css("border",""),node=n.dragElement.get(0),n.selectNode(node),n.loadNodeComponent(node),!1===n.dragMoveMutation?t.Undo.addMutation({type:"childList",target:node.parentNode,addedNodes:[node],nextSibling:node.nextSibling}):(n.dragMoveMutation.newParent=node.parentNode,n.dragMoveMutation.newNextSibling=node.nextSibling,t.Undo.addMutation(n.dragMoveMutation),n.dragMoveMutation=!1))}),n.frameHtml.on("dblclick",function(e){0==t.Builder.isPreview&&(n.texteditEl=target=o(e.target),t.WysiwygEditor.edit(n.texteditEl),n.texteditEl.attr({contenteditable:!0,spellcheckker:!1}),n.texteditEl.on("blur keyup paste input",function(e){o("#select-box").css({width:n.texteditEl.outerWidth(),height:n.texteditEl.outerHeight()})}),o("#select-box").addClass("text-edit").find("#select-actions").hide(),o("#highlight-box").hide())}),n.frameHtml.on("click",function(o){if(0==t.Builder.isPreview)return o.target&&(e(".component-properties-tab").is(":visible")&&e(".component-properties-tab a").show().tab("show"),n.selectNode(o.target),n.loadNodeComponent(o.target)),o.preventDefault(),!1})},_initBox:function(){var n=this;e("#drag-btn").on("mousedown",function(e){return o("#select-box").hide(),n.dragElement=n.selectedEl.css("position",""),n.isDragging=!0,node=n.dragElement.get(0),n.dragMoveMutation={type:"move",target:node,oldParent:node.parentNode,oldNextSibling:node.nextSibling},e.preventDefault(),!1}),e("#down-btn").on("click",function(e){return o("#select-box").hide(),node=n.selectedEl.get(0),oldParent=node.parentNode,oldNextSibling=node.nextSibling,next=n.selectedEl.next(),next.length>0?next.after(n.selectedEl):n.selectedEl.parent().after(n.selectedEl),newParent=node.parentNode,newNextSibling=node.nextSibling,t.Undo.addMutation({type:"move",target:node,oldParent:oldParent,newParent:newParent,oldNextSibling:oldNextSibling,newNextSibling:newNextSibling}),e.preventDefault(),!1}),e("#up-btn").on("click",function(e){return o("#select-box").hide(),node=n.selectedEl.get(0),oldParent=node.parentNode,oldNextSibling=node.nextSibling,next=n.selectedEl.prev(),next.length>0?next.before(n.selectedEl):n.selectedEl.parent().before(n.selectedEl),newParent=node.parentNode,newNextSibling=node.nextSibling,t.Undo.addMutation({type:"move",target:node,oldParent:oldParent,newParent:newParent,oldNextSibling:oldNextSibling,newNextSibling:newNextSibling}),e.preventDefault(),!1}),e("#clone-btn").on("click",function(e){return clone=n.selectedEl.clone(),n.selectedEl.after(clone),n.selectedEl=clone.click(),node=clone.get(0),t.Undo.addMutation({type:"childList",target:node.parentNode,addedNodes:[node],nextSibling:node.nextSibling}),e.preventDefault(),!1}),e("#parent-btn").on("click",function(e){return node=n.selectedEl.parent().get(0),n.selectNode(node),n.loadNodeComponent(node),e.preventDefault(),!1}),e("#delete-btn").on("click",function(e){return o("#select-box").hide(),node=n.selectedEl.get(0),t.Undo.addMutation({type:"childList",target:node.parentNode,removedNodes:[node],nextSibling:node.nextSibling}),n.selectedEl.remove(),e.preventDefault(),!1});var i=o("#add-section-box"),a={};function l(o,n=!0){var i=e(o);n?a.after(i):a.append(i),i=i.get(0),t.Undo.addMutation({type:"childList",target:i.parentNode,addedNodes:[i],nextSibling:i.nextSibling})}e("#add-section-btn").on("click",function(t){a=n.highlightEl;var l=o(a).offset(),r=l.top-n.frameDoc.scrollTop()+a.outerHeight(),d=l.left-n.frameDoc.scrollLeft()+a.outerWidth()/2-i.outerWidth()/2,c=e(window.FrameWindow).height()+n.frameDoc.scrollTop();return d<0&&(d=0),r<0&&(r=0),d+i.outerWidth()>n.frameDoc.outerWidth()&&(d=n.frameDoc.outerWidth()-i.outerWidth()),r+i.outerHeight()+n.frameDoc.scrollTop()>c&&(r-=i.outerHeight()),i.css({top:r,left:d,display:"block"}),t.preventDefault(),!1}),e("#close-section-btn").on("click",function(e){i.hide()}),e(".components-list li ol li",i).on("click",function(e){l(t.Components.get(this.dataset.type).html,"after"==o("[name='add-section-insert-mode']:checked").val()),i.hide()}),e(".blocks-list li ol li",i).on("click",function(e){l(t.Blocks.get(this.dataset.type).html,"after"==o("[name='add-section-insert-mode']:checked").val()),i.hide()})},_initDragdrop:function(){var n=this;n.isDragging=!1,e(".drag-elements-sidepane ul > li > ol > li").on("mousedown touchstart",function(i){return $this=o(this),e("#component-clone").remove(),"component"==$this.data("drag-type")?n.component=t.Components.get($this.data("type")):n.component=t.Blocks.get($this.data("type")),n.component.dragHtml?html=n.component.dragHtml:html=n.component.html,n.dragElement=e(html),n.dragElement.css("border","1px dashed #4285f4"),n.component.dragStart&&(n.dragElement=n.component.dragStart(n.dragElement)),n.isDragging=!0,"html"==t.dragIcon?n.iconDrag=e(html).attr("id","dragElement-clone").css("position","absolute"):0==n.designerMode&&(n.iconDrag=e('<img src=""/>').attr({id:"dragElement-clone",src:$this.css("background-image").replace(/^url\(['"](.+)['"]\)/,"$1")}).css({"z-index":100,position:"absolute",width:"64px",height:"64px",top:i.originalEvent.y,left:i.originalEvent.x})),e("body").append(n.iconDrag),i.preventDefault(),!1}),e("body").on("mouseup touchend",function(t){n.iconDrag&&1==n.isDragging&&(n.isDragging=!1,e("#component-clone").remove(),n.iconDrag.remove(),n.dragElement&&n.dragElement.remove())}),e("body").on("mousemove touchmove",function(e){if(n.iconDrag&&1==n.isDragging){var t=e.clientX||e.originalEvent.clientX,o=e.clientY||e.originalEvent.clientY;n.iconDrag.css({left:t-60,top:o-30}),elementMouseIsOver=document.elementFromPoint(t-60,o-40),elementMouseIsOver&&"IFRAME"==elementMouseIsOver.tagName&&(n.frameBody.trigger("mousemove",e),e.stopPropagation(),n.selectNode(!1))}}),e(".drag-elements-sidepane ul > ol > li > li").on("mouseup touchend",function(t){n.isDragging=!1,e("#component-clone").remove()})},removeHelpers:function(e,t=!1){return e=e.replace(/<.*?data-vvveb-helpers.*?>/gi,""),t||(e=e.replace(/\s*data-vvveb-\w+(=["'].*?["'])?\s*/gi,"")),e},getHtml:function(t=!0){var o=window.FrameDocument,n=null!==o.doctype,i="";e(window).triggerHandler("vvveb.getHtml.before",o),n&&(i="<!DOCTYPE "+o.doctype.name+(o.doctype.publicId?' PUBLIC "'+o.doctype.publicId+'"':"")+(!o.doctype.publicId&&o.doctype.systemId?" SYSTEM":"")+(o.doctype.systemId?' "'+o.doctype.systemId+'"':"")+">\n"),i+=o.documentElement.innerHTML+"\n</html>",i=this.removeHelpers(i,t);var a=e(window).triggerHandler("vvveb.getHtml.after",i);return a||i},setHtml:function(e){start=e.indexOf("<body"),end=e.indexOf("</body"),start>=0&&end>=0?body=e.slice(e.indexOf(">",start)+1,end):body=e,this.runJsOnSetHtml?self.frameBody.html(body):window.FrameDocument.body.innerHTML=body},saveAjax:function(o,n,i){var a={};a.fileName=o&&""!=o?o:t.FileManager.getCurrentUrl(),a.startTemplateUrl=n,n&&null!=n||(a.html=this.getHtml()),e.ajax({type:"POST",url:"save.php",data:a,cache:!1,success:function(e){i&&i(e)},error:function(e){alert(e.responseText)}})},setDesignerMode:function(e=!1){this.designerMode=e}}});
//# sourceMappingURL=sourcemaps/Builder.js.map
