/**
 * skylark-vvveb - A version of Vvveb.js that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-vvveb/
 * @license MIT
 */
define(["skylark-utils-dom/query","./Vvveb"],function(e,t){return t.Builder={component:{},dragMoveMutation:!1,isPreview:!1,runJsOnSetHtml:!1,designerMode:!1,init:function(t,n){this.loadControlGroups(),this.loadBlockGroups(),this.selectedEl=null,this.highlightEl=null,this.initCallback=n,this.documentFrame=e("#iframe-wrapper > iframe"),this.canvas=e("#canvas"),this._loadIframe(t),this._initDragdrop(),this._initBox(),this.dragElement=null},loadControlGroups:function(){var n=e(".components-list");n.empty();var o={},a={};n.each(function(){var n=e(this),r=this.dataset.type;for(group in t.ComponentsGroup){n.append('<li class="header clearfix" data-section="'+group+'"  data-search=""><label class="header" for="'+r+"_comphead_"+group+'">'+group+'  <div class="header-arrow"></div>\t\t\t\t\t\t\t\t\t\t   </label><input class="header_check" type="checkbox" checked="true" id="'+r+"_comphead_"+group+'">  <ol></ol></li>');var l=n.find('li[data-section="'+group+'"]  ol');for(i in components=t.ComponentsGroup[group],components)componentType=components[i],(a=t.Components.get(componentType))&&(o=e('<li data-section="'+group+'" data-drag-type=component data-type="'+componentType+'" data-search="'+a.name.toLowerCase()+'"><a href="#">'+a.name+"</a></li>"),a.image&&o.css({backgroundImage:"url(libs/builder/"+a.image+")",backgroundRepeat:"no-repeat"}),l.append(o))}})},loadBlockGroups:function(){var n=e(".blocks-list");n.empty();var o={};n.each(function(){var n=e(this),a=this.dataset.type;for(group in t.BlocksGroup){n.append('<li class="header" data-section="'+group+'"  data-search=""><label class="header" for="'+a+"_blockhead_"+group+'">'+group+'  <div class="header-arrow"></div>\t\t\t\t\t\t\t\t\t\t   </label><input class="header_check" type="checkbox" checked="true" id="'+a+"_blockhead_"+group+'">  <ol></ol></li>');var r=n.find('li[data-section="'+group+'"]  ol');for(i in blocks=t.BlocksGroup[group],blocks)blockType=blocks[i],block=t.Blocks.get(blockType),block&&(o=e('<li data-section="'+group+'" data-drag-type=block data-type="'+blockType+'" data-search="'+block.name.toLowerCase()+'"><a href="#">'+block.name+"</a></li>"),block.image&&o.css({backgroundImage:"url("+(-1==block.image.indexOf("//")?"libs/builder/":"")+block.image+")",backgroundRepeat:"no-repeat"}),r.append(o))}})},loadUrl:function(e,n){jQuery("#select-box").hide(),self.initCallback=n,t.Builder.iframe.src!=e&&(t.Builder.iframe.src=e)},_loadIframe:function(n){var o=this;return o.iframe=this.documentFrame.get(0),o.iframe.src=n,this.documentFrame.on("load",function(){return window.FrameWindow=o.iframe.contentWindow,window.FrameDocument=o.iframe.contentWindow.document,e(window.FrameWindow).on("beforeunload",function(e){if(t.Undo.undoIndex<=0){return e.returnValue="You have unsaved changes","You have unsaved changes"}}),jQuery(window.FrameWindow).on("scroll resize",function(e){if(o.selectedEl){var t=o.selectedEl.offset();jQuery("#select-box").css({top:t.top-o.frameDoc.scrollTop(),left:t.left-o.frameDoc.scrollLeft(),width:o.selectedEl.outerWidth(),height:o.selectedEl.outerHeight()})}if(o.highlightEl){t=o.highlightEl.offset();jQuery("#highlight-box").css({top:t.top-o.frameDoc.scrollTop(),left:t.left-o.frameDoc.scrollLeft(),width:o.highlightEl.outerWidth(),height:o.highlightEl.outerHeight()})}}),t.WysiwygEditor.init(window.FrameDocument),o.initCallback&&o.initCallback(),o._frameLoaded()})},_frameLoaded:function(){var n=t.Builder;n.frameDoc=e(window.FrameDocument),n.frameHtml=e(window.FrameDocument).find("html"),n.frameBody=e(window.FrameDocument).find("body"),n.frameHead=e(window.FrameDocument).find("head"),n.frameHead.append('<link data-vvveb-helpers href="'+t.baseUrl+'../../css/vvvebjs-editor-helpers.css" rel="stylesheet">'),n._initHighlight()},_getElementType:function(e){if(componentName="",e.attributes)for(var t=0;t<e.attributes.length;t++)e.attributes[t].nodeName.indexOf("data-component")>-1&&(componentName=e.attributes[t].nodeName.replace("data-component-",""));return""!=componentName?componentName:e.tagName},loadNodeComponent:function(e){var n;data=t.Components.matchNode(e),n=data?data.type:t.defaultComponent,t.Components.render(n)},selectNode:function(e){if(e){this.texteditEl&&this.selectedEl.get(0)!=e&&(t.WysiwygEditor.destroy(this.texteditEl),jQuery("#select-box").removeClass("text-edit").find("#select-actions").show(),this.texteditEl=null);var n=jQuery(e);if(n){this.selectedEl=n;try{var o=n.offset();jQuery("#select-box").css({top:o.top-this.frameDoc.scrollTop(),left:o.left-this.frameDoc.scrollLeft(),width:n.outerWidth(),height:n.outerHeight(),display:"block"})}catch(e){return console.log(e),!1}}jQuery("#highlight-name").html(this._getElementType(e))}else jQuery("#select-box").hide()},_initHighlight:function(){var n=t.Builder;n.frameHtml.on("mousemove touchmove",function(e){if(e.target&&isElement(e.target)&&e.originalEvent){n.highlightEl=target=jQuery(e.target);var t=target.offset(),o=target.outerHeight(),i=Math.max(o/2,50),a=target.outerWidth(),r=Math.max(a/2,50),l=e.clientX||e.originalEvent.clientX,d=e.clientY||e.originalEvent.clientY;if(n.isDragging){var c=n.highlightEl;try{if(e.originalEvent&&(t.top<d-i||t.left<l-r?isIE11?n.highlightEl.append(n.dragElement):n.dragElement.appendTo(c):isIE11?n.highlightEl.prepend(n.dragElement):n.dragElement.prependTo(c),n.designerMode)){var s=n.dragElement.offsetParent().offset();n.dragElement.css({position:"absolute",left:l-(s.left-n.frameDoc.scrollLeft()),top:d-(s.top-n.frameDoc.scrollTop())})}}catch(e){return console.log(e),!1}!n.designerMode&&n.iconDrag&&n.iconDrag.css({left:l+275,top:d-30})}jQuery("#highlight-box").css({top:t.top-n.frameDoc.scrollTop(),left:t.left-n.frameDoc.scrollLeft(),width:a,height:o,display:e.target.hasAttribute("contenteditable")?"none":"block",border:n.isDragging?"1px dashed aqua":""}),jQuery("#highlight-name").html(n._getElementType(e.target)),n.isDragging?jQuery("#highlight-name").hide():jQuery("#highlight-name").show()}}),n.frameHtml.on("mouseup touchend",function(o){n.isDragging&&(n.isDragging=!1,n.iconDrag&&n.iconDrag.remove(),e("#component-clone").remove(),n.component.dragHtml&&(newElement=e(n.component.html),n.dragElement.replaceWith(newElement),n.dragElement=newElement),n.component.afterDrop&&(n.dragElement=n.component.afterDrop(n.dragElement)),n.dragElement.css("border",""),node=n.dragElement.get(0),n.selectNode(node),n.loadNodeComponent(node),!1===n.dragMoveMutation?t.Undo.addMutation({type:"childList",target:node.parentNode,addedNodes:[node],nextSibling:node.nextSibling}):(n.dragMoveMutation.newParent=node.parentNode,n.dragMoveMutation.newNextSibling=node.nextSibling,t.Undo.addMutation(n.dragMoveMutation),n.dragMoveMutation=!1))}),n.frameHtml.on("dblclick",function(e){0==t.Builder.isPreview&&(n.texteditEl=target=jQuery(e.target),t.WysiwygEditor.edit(n.texteditEl),n.texteditEl.attr({contenteditable:!0,spellcheckker:!1}),n.texteditEl.on("blur keyup paste input",function(e){jQuery("#select-box").css({width:n.texteditEl.outerWidth(),height:n.texteditEl.outerHeight()})}),jQuery("#select-box").addClass("text-edit").find("#select-actions").hide(),jQuery("#highlight-box").hide())}),n.frameHtml.on("click",function(o){if(0==t.Builder.isPreview)return o.target&&(e(".component-properties-tab").is(":visible")&&e(".component-properties-tab a").show().tab("show"),n.selectNode(o.target),n.loadNodeComponent(o.target)),o.preventDefault(),!1})},_initBox:function(){var n=this;e("#drag-btn").on("mousedown",function(e){return jQuery("#select-box").hide(),n.dragElement=n.selectedEl.css("position",""),n.isDragging=!0,node=n.dragElement.get(0),n.dragMoveMutation={type:"move",target:node,oldParent:node.parentNode,oldNextSibling:node.nextSibling},e.preventDefault(),!1}),e("#down-btn").on("click",function(e){return jQuery("#select-box").hide(),node=n.selectedEl.get(0),oldParent=node.parentNode,oldNextSibling=node.nextSibling,next=n.selectedEl.next(),next.length>0?next.after(n.selectedEl):n.selectedEl.parent().after(n.selectedEl),newParent=node.parentNode,newNextSibling=node.nextSibling,t.Undo.addMutation({type:"move",target:node,oldParent:oldParent,newParent:newParent,oldNextSibling:oldNextSibling,newNextSibling:newNextSibling}),e.preventDefault(),!1}),e("#up-btn").on("click",function(e){return jQuery("#select-box").hide(),node=n.selectedEl.get(0),oldParent=node.parentNode,oldNextSibling=node.nextSibling,next=n.selectedEl.prev(),next.length>0?next.before(n.selectedEl):n.selectedEl.parent().before(n.selectedEl),newParent=node.parentNode,newNextSibling=node.nextSibling,t.Undo.addMutation({type:"move",target:node,oldParent:oldParent,newParent:newParent,oldNextSibling:oldNextSibling,newNextSibling:newNextSibling}),e.preventDefault(),!1}),e("#clone-btn").on("click",function(e){return clone=n.selectedEl.clone(),n.selectedEl.after(clone),n.selectedEl=clone.click(),node=clone.get(0),t.Undo.addMutation({type:"childList",target:node.parentNode,addedNodes:[node],nextSibling:node.nextSibling}),e.preventDefault(),!1}),e("#parent-btn").on("click",function(e){return node=n.selectedEl.parent().get(0),n.selectNode(node),n.loadNodeComponent(node),e.preventDefault(),!1}),e("#delete-btn").on("click",function(e){return jQuery("#select-box").hide(),node=n.selectedEl.get(0),t.Undo.addMutation({type:"childList",target:node.parentNode,removedNodes:[node],nextSibling:node.nextSibling}),n.selectedEl.remove(),e.preventDefault(),!1});var o=jQuery("#add-section-box"),i={};function a(n,o=!0){var a=e(n);o?i.after(a):i.append(a),a=a.get(0),t.Undo.addMutation({type:"childList",target:a.parentNode,addedNodes:[a],nextSibling:a.nextSibling})}e("#add-section-btn").on("click",function(t){i=n.highlightEl;var a=jQuery(this).offset();return o.css({top:a.top-n.frameDoc.scrollTop()-e(this).outerHeight(),left:a.left-o.outerWidth()/2-275-n.frameDoc.scrollLeft(),display:"block"}),t.preventDefault(),!1}),e("#close-section-btn").on("click",function(e){o.hide()}),e(".components-list li ol li",o).on("click",function(e){a(t.Components.get(this.dataset.type).html,"after"==jQuery("[name='add-section-insert-mode']:checked").val()),o.hide()}),e(".blocks-list li ol li",o).on("click",function(e){a(t.Blocks.get(this.dataset.type).html,"after"==jQuery("[name='add-section-insert-mode']:checked").val()),o.hide()})},_initDragdrop:function(){var n=this;n.isDragging=!1,e(".drag-elements-sidepane ul > li > ol > li").on("mousedown touchstart",function(o){return $this=jQuery(this),e("#component-clone").remove(),"component"==$this.data("drag-type")?n.component=t.Components.get($this.data("type")):n.component=t.Blocks.get($this.data("type")),n.component.dragHtml?html=n.component.dragHtml:html=n.component.html,n.dragElement=e(html),n.dragElement.css("border","1px dashed #4285f4"),n.component.dragStart&&(n.dragElement=n.component.dragStart(n.dragElement)),n.isDragging=!0,"html"==t.dragIcon?n.iconDrag=e(html).attr("id","dragElement-clone").css("position","absolute"):0==n.designerMode&&(n.iconDrag=e('<img src=""/>').attr({id:"dragElement-clone",src:$this.css("background-image").replace(/^url\(['"](.+)['"]\)/,"$1")}).css({"z-index":100,position:"absolute",width:"64px",height:"64px",top:o.originalEvent.y,left:o.originalEvent.x})),e("body").append(n.iconDrag),o.preventDefault(),!1}),e("body").on("mouseup touchend",function(t){n.iconDrag&&1==n.isDragging&&(n.isDragging=!1,e("#component-clone").remove(),n.iconDrag.remove(),n.dragElement&&n.dragElement.remove())}),e("body").on("mousemove touchmove",function(e){if(n.iconDrag&&1==n.isDragging){var t=e.clientX||e.originalEvent.clientX,o=e.clientY||e.originalEvent.clientY;n.iconDrag.css({left:t-60,top:o-30}),elementMouseIsOver=document.elementFromPoint(t-60,o-40),elementMouseIsOver&&"IFRAME"==elementMouseIsOver.tagName&&(n.frameBody.trigger("mousemove",e),e.stopPropagation(),n.selectNode(!1))}}),e(".drag-elements-sidepane ul > ol > li > li").on("mouseup touchend",function(t){n.isDragging=!1,e("#component-clone").remove()})},removeHelpers:function(e,t=!1){return e=e.replace(/<.*?data-vvveb-helpers.*?>/gi,""),t||(e=e.replace(/\s*data-vvveb-\w+(=["'].*?["'])?\s*/gi,"")),e},getHtml:function(e=!0){var t=window.FrameDocument,n="";return null!==t.doctype&&(n="<!DOCTYPE "+t.doctype.name+(t.doctype.publicId?' PUBLIC "'+t.doctype.publicId+'"':"")+(!t.doctype.publicId&&t.doctype.systemId?" SYSTEM":"")+(t.doctype.systemId?' "'+t.doctype.systemId+'"':"")+">\n"),n+=t.documentElement.innerHTML+"\n</html>",this.removeHelpers(n,e)},setHtml:function(e){start=e.indexOf("<body"),end=e.indexOf("</body"),start>=0&&end>=0?body=e.slice(e.indexOf(">",start)+1,end):body=e,this.runJsOnSetHtml?self.frameBody.html(body):window.FrameDocument.body.innerHTML=body},saveAjax:function(n,o,i){var a={};a.fileName=n&&""!=n?n:t.FileManager.getCurrentUrl(),a.startTemplateUrl=o,o&&null!=o||(a.html=this.getHtml()),e.ajax({type:"POST",url:"save.php",data:a,cache:!1,success:function(e){i&&i(e)},error:function(e){alert(e.responseText)}})},setDesignerMode:function(e=!1){this.designerMode=e}}});
//# sourceMappingURL=sourcemaps/Builder.js.map
